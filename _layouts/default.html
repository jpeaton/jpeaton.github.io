<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ page.title }} | {{ site.title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="/assets/main.css" />
  </head>

  <body>
    <main class="terminal">
      {{ content }}
    </main>
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const container = document.querySelector("main.terminal");
  if (!container) return;

  // Respect reduced motion
  if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

  // Only do the special "command + pause" on the homepage
  const isHome = window.location.pathname === "/" || window.location.pathname.endsWith("/index.html");

  // Speeds
  const CHAR_DELAY_MS = 6;        // typing speed
  const NODE_PAUSE_MS = 40;       // pause between text nodes
  const COMMAND_PAUSE_MS = 450;   // pause after command finishes typing

  // Create ONE cursor for the whole page
  const cursor = document.createElement("span");
  cursor.id = "term-cursor";
  cursor.classList.add("idle");
  cursor.textContent = "█"; // block is via background
  container.appendChild(cursor);

  // Collect all text nodes (skip code/pre)
  const walker = document.createTreeWalker(
    container,
    NodeFilter.SHOW_TEXT,
    {
      acceptNode(node) {
        if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
        const parent = node.parentElement;
        if (parent && (parent.closest("pre") || parent.closest("code"))) return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }
    }
  );

  const nodes = [];
  let n;
  while ((n = walker.nextNode())) nodes.push(n);

  // Save originals and clear text
  const originals = nodes.map(node => node.nodeValue);
  nodes.forEach(node => (node.nodeValue = ""));

  // Helper: move cursor to "insertion point" after a specific text node
  function moveCursorAfterTextNode(node) {
  const parentEl = node.parentElement;
  if (!parentEl) return;
  parentEl.appendChild(cursor); // ensures cursor is at end of that element’s visible text
  }

  let nodeIndex = 0;
  let charIndex = 0;

  // We pause after the first H1 on homepage (your "./run_website_for_jeremiah.sh")
  // We'll detect that by checking the first time we finish typing inside an H1.
  let didCommandPause = false;

  function typeNextChar() {
    if (nodeIndex >= nodes.length) {
      cursor.classList.add("idle");
      return;
    }

    cursor.classList.remove("idle"); // solid while actively typing

    const node = nodes[nodeIndex];
    const full = originals[nodeIndex];

    node.nodeValue = full.slice(0, charIndex + 1);
    moveCursorAfterTextNode(node);

    charIndex++;

    if (charIndex < full.length) {
      setTimeout(typeNextChar, CHAR_DELAY_MS);
      return;
    }

    // Finished this node
    const parentEl = node.parentElement;

    nodeIndex++;
    charIndex = 0;

    // If this text node lived in the first H1 on the homepage, do the "command executing" pause once
    if (isHome && !didCommandPause && parentEl && parentEl.tagName === "H1") {
      didCommandPause = true;
      cursor.classList.add("idle"); // blink while "running"
      setTimeout(typeNextChar, COMMAND_PAUSE_MS);
      return;
    }

    cursor.classList.add("idle");
    setTimeout(typeNextChar, NODE_PAUSE_MS);
  }

  // Start with cursor at top
  cursor.classList.add("idle");
  typeNextChar();
});
  </script>
  </body>
</html>
